{% extends "base.html" %}

{% block title %}{{ job.tool_name }} - Aye Chef{% endblock %}

{% block body %}
<div class="max-w-2xl mx-auto py-8 px-4">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
        <div>
            <h1 class="font-display text-2xl text-primary">{{ job.tool_name }}</h1>
            <p class="text-sm text-muted">{{ job.created_at[:16].replace('T', ' ') }}</p>
        </div>
        <div class="flex items-center gap-3">
            <button id="stop-btn" onclick="stopJob()" 
                    class="{% if job.status not in ['pending', 'running'] %}hidden{% endif %} px-4 py-1.5 bg-error hover:bg-error/80 text-white rounded-lg text-sm font-medium transition">
                Stop
            </button>
            <span id="status-badge" class="px-3 py-1 rounded-full text-sm font-medium
                {% if job.status == 'running' or job.status == 'pending' %}bg-warning/20 text-warning
                {% elif job.status == 'completed' %}bg-success/20 text-success
                {% else %}bg-error/20 text-error{% endif %}">
                {{ job.status }}
            </span>
        </div>
    </header>

    <!-- Terminal Output -->
    <div class="card rounded-xl overflow-hidden mb-4">
        <div class="terminal p-4 font-mono text-sm overflow-auto max-h-[600px] text-gray-300"
             id="output">
            {% if initial_output %}
            {% for line in initial_output.split('\n') %}
            {% if line %}<div>{{ line }}</div>{% endif %}
            {% endfor %}
            {% elif job.status in ['pending', 'running'] %}
            <div class="text-amber-400 animate-pulse">Starting...</div>
            {% endif %}
        </div>
    </div>

    <!-- WhatsApp Message Section -->
    <div id="whatsapp-section" class="{% if not whatsapp_message %}hidden{% endif %} mb-4">
        <div class="card rounded-xl p-5 border-l-4 border-success">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-display text-lg text-primary">Ready to Share</h2>
                <button onclick="copyMessage()" id="copy-btn"
                        class="px-4 py-2 bg-success hover:bg-success/80 text-white rounded-lg text-sm font-medium transition">
                    Copy to Clipboard
                </button>
            </div>
            <p class="text-muted text-sm mb-3">Paste this into your WhatsApp group:</p>
            <div class="bg-subtle rounded-lg p-4 max-h-[300px] overflow-auto">
                <pre id="whatsapp-message" class="text-sm text-primary whitespace-pre-wrap font-sans leading-relaxed">{% if whatsapp_message %}{{ whatsapp_message }}{% endif %}</pre>
            </div>
        </div>
    </div>

    <!-- Images Section -->
    {% if job.result and job.result.image_results %}
    <details class="card rounded-xl mb-3 group">
        <summary class="p-4 font-medium flex items-center justify-between">
            <span class="text-primary">Images</span>
            <div class="flex items-center gap-3">
                <span class="text-sm text-muted">
                    {{ job.result.image_results.success_count }} of {{ job.result.image_results.results|length }}
                </span>
                <svg class="w-5 h-5 text-muted group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </summary>
        <div class="px-4 pb-4 border-t border-border">
            <!-- Results list -->
            <div class="divide-y divide-border">
                {% for item in job.result.image_results.results %}
                <div class="py-2 flex items-center gap-2">
                    {% if item.status == 'success' %}
                    <span class="text-success">✓</span>
                    {% else %}
                    <span class="text-warning">⚠</span>
                    {% endif %}
                    <span class="text-primary text-sm">{{ item.recipe }}</span>
                    {% if item.status != 'success' %}
                    <span class="text-muted text-xs">— {{ item.message }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            {% if job.result.image_results.rate_limited %}
            <div class="mt-3 p-2 bg-warning/20 rounded text-sm text-warning">
                ⚠ Brave API limit reached — remaining recipes skipped
            </div>
            {% endif %}
        </div>
    </details>
    {% endif %}

    <!-- Error Message -->
    {% if job.error %}
    <div class="card rounded-xl p-4 mb-4 border-l-4 border-error">
        <p class="font-medium text-error text-sm">Error</p>
        <p class="text-error/80 text-sm mt-1">{{ job.error }}</p>
    </div>
    {% endif %}

    <!-- Back -->
    <a href="/" class="inline-flex items-center gap-2 text-accent hover:text-accent-hover font-medium transition">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Back
    </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
const output = document.getElementById('output');
const isRunning = {{ 'true' if job.status in ['pending', 'running'] else 'false' }};

// Throttle scroll to avoid performance issues
let scrollPending = false;
function throttledScroll() {
    if (scrollPending) return;
    scrollPending = true;
    requestAnimationFrame(() => {
        const isNearBottom = output.scrollHeight - output.scrollTop - output.clientHeight < 100;
        if (isNearBottom) {
            output.scrollTop = output.scrollHeight;
        }
        scrollPending = false;
    });
}

// SSE streaming with vanilla JavaScript
if (isRunning) {
    const eventSource = new EventSource('/jobs/{{ job.id }}/stream');
    
    eventSource.onmessage = function(e) {
        // Use insertAdjacentHTML instead of innerHTML += (MUCH faster)
        output.insertAdjacentHTML('beforeend', e.data);
        throttledScroll();
    };
    
    eventSource.addEventListener('done', function(e) {
        output.insertAdjacentHTML('beforeend', e.data);
        eventSource.close();
        
        // Update UI
        const badge = document.getElementById('status-badge');
        const stopBtn = document.getElementById('stop-btn');
        stopBtn.classList.add('hidden');
        
        const isPlanComplete = e.data && e.data.includes('data-plan-complete');
        const isCompleted = e.data && e.data.includes('completed');
        
        if (isCompleted || isPlanComplete) {
            badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-success/20 text-success';
            badge.textContent = 'completed';
            
            if (isPlanComplete) {
                fetch('/jobs/{{ job.id }}/whatsapp')
                    .then(r => r.json())
                    .then(resp => {
                        if (resp.message) {
                            document.getElementById('whatsapp-message').textContent = resp.message;
                            document.getElementById('whatsapp-section').classList.remove('hidden');
                        }
                    });
            }
        } else {
            badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-error/20 text-error';
            badge.textContent = 'failed';
        }
    });
    
    eventSource.onerror = function() {
        eventSource.close();
    };
}

function stopJob() {
    const btn = document.getElementById('stop-btn');
    btn.textContent = 'Stopping...';
    btn.disabled = true;
    
    fetch('/jobs/{{ job.id }}/cancel', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                btn.classList.add('hidden');
                document.getElementById('status-badge').textContent = 'cancelled';
                document.getElementById('status-badge').className = 'px-3 py-1 rounded-full text-sm font-medium bg-error/20 text-error';
            } else {
                btn.textContent = 'Stop';
                btn.disabled = false;
            }
        })
        .catch(() => {
            btn.textContent = 'Stop';
            btn.disabled = false;
        });
}

function copyMessage() {
    const message = document.getElementById('whatsapp-message').textContent;
    const btn = document.getElementById('copy-btn');
    
    function showSuccess() {
        btn.textContent = '✓ Copied!';
        btn.classList.remove('bg-success', 'hover:bg-success/80');
        btn.classList.add('bg-primary');
        setTimeout(() => {
            btn.textContent = 'Copy to Clipboard';
            btn.classList.remove('bg-primary');
            btn.classList.add('bg-success', 'hover:bg-success/80');
        }, 2000);
    }
    
    function fallbackCopy() {
        const textarea = document.createElement('textarea');
        textarea.value = message;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
            document.execCommand('copy');
            showSuccess();
        } catch (err) {
            btn.textContent = 'Failed';
            setTimeout(() => { btn.textContent = 'Copy to Clipboard'; }, 2000);
        }
        document.body.removeChild(textarea);
    }
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(message).then(showSuccess).catch(fallbackCopy);
    } else {
        fallbackCopy();
    }
}
</script>
{% endblock %}
